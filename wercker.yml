box: plasticine/aerobic.io@0.0.5
services:
    - wercker/postgresql
    - wercker/redis
build:
    # The steps that will be executed on build
    steps:
        - script:
            name: configure framebuffer
            code: |
                export DISPLAY=${DISPLAY:-":2.0"}
                /sbin/start-stop-daemon --start --quiet --pidfile /tmp/xvfb_$DISPLAY.pid --make-pidfile --background --exec /usr/bin/Xvfb -- "$DISPLAY" -ac -screen scrn 1400x1200x24
                cat /tmp/xvfb_$DISPLAY.pid
        # A step that executes `bundle install` command
        - bundle-install
        # A step that prepares the database.yml with settings from the database you defined in services
        - rails-database-yml
        # A step that executes `npm install`
        - npm-install
        # Install python development tools
        - pip-install:
            requirements_file: ".pip"
        # A step that executes `bower install`
        - plasticine/bower-install
        # Ensure that selenium server is available and running (move this to a service?)
        - desmondmorris/selenium-install@0.0.2
        # ...and run the build!
        - script:
            name: db setup
            code: RAILS_ENV=test bundle exec rake db:structure:load
        - script:
            name: consistency fail
            code: RAILS_ENV=test bundle exec consistency_fail
        - script:
            name: teaspoon
            code: RAILS_ENV=test bundle exec teaspoon
        - script:
            name: rspec
            code: bundle exec rspec --format=progress
        - script:
            name: cucumber
            code: bundle exec cucumber
        - script:
            name: huxley
            code: script/huxley test
        - script:
            name: quality
            code: bundle exec rake quality
        - script:
            name: best practices
            code: bundle exec rails_best_practices .
    after-steps:
        - script:
            name: build artifacts
            code: |
                cp -R coverage $WERCKER_REPORT_ARTIFACTS_DIR
        - plasticine/librato-build-metrics@0.0.18:
            user: $LIBRATO_USER
            token: $LIBRATO_TOKEN
            namespace: aerobicio
        # - wercker/campfire-notify@0.1.1:
        #     token: $CAMPFIRE_TOKEN
        #     room-id: 541059
        #     subdomain: aerobicio
        #     on: failed

deploy:
    steps:
        - heroku-deploy
        - script:
            name: Migrate Database
            code: heroku run rake db:migrate --app $TARGET_NAME
